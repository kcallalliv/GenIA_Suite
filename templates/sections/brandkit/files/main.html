{% extends "sections/template-proyectos.html" %}
{% block title %}GenIA{% endblock %}
{% block content %}

		<section class="content">
			<main class="logo-content">
				<h1 class="section-title">Files</h1>

				<div class="info-banner">
					<span class="dot" aria-hidden="true"></span>
					<span>Carga la mayor cantidad de variaciones disponibles de archivos. Esto nos permitirá generar contenido de manera más acertada.</span>
				</div>
				<input type="hidden" id="txt_pid" name="txt_pid" value="{{pid}}">
				<div class="tiles">
					<div class="tile-upload" role="button" aria-label="Agregar logo">
						<div class="tile-upload__inner">
							<div class="plus">+</div>
						</div>
					</div>
					{% for lista in lista %}
					{% set myid = lista['asset_id'] %}
					{% set myname = lista['asset_name'] %}
					{% set mysrc = lista['asset_src'] %}
					{% set myimage = generar_url_firmada("genia_information",mysrc) %}
					<div class="tile-photo" role="button" data-name="{{myname}}" data_id="{{myid}}" aria-label="Agregar file">
						<div class="ico-{{lista['asset_ext']}}"></div>
						<div class="lbl-text">{{lista['asset_name']}}</div>
						<div class="item-close">×</div>
					</div>
					{% endfor %}
				</div>
				<div class="actions">
				  <button class="btn btn-primary" type="button" id="send-photos-button">Subir Photos</button>
				</div>

				<div class="helper">
					<span class="pill" aria-hidden="true"></span>
					<span id="lbl_mensaje"></span>
				</div>
			</main>
		</section>
<script>
const uploadTile = document.querySelector('.tile-upload');
	const container = document.querySelector('.tiles');
	const filesArray = [];

	// Función unificada para la lógica de eliminación
	function setupCloseButton(tileElement, fileObject) {
		const closeButton = tileElement.querySelector('.item-close');
		if (!closeButton) return;

		closeButton.addEventListener('click', (event) => {
			event.stopPropagation();
			
			const indexToRemove = filesArray.findIndex(item => item === fileObject);
			if (indexToRemove !== -1) {
				filesArray.splice(indexToRemove, 1);
				console.log('Elemento eliminado del array. Array actualizado:', filesArray);
			}
			
			if (fileObject && fileObject.file) {
				URL.revokeObjectURL(tileElement.style.backgroundImage.slice(5, -2));
			}
			
			tileElement.remove();
		});
	}

	// Inicializa los tiles existentes y los añade al array
	const existingTiles = document.querySelectorAll('.tile-photo[data_id]');
	existingTiles.forEach((tile) => {
		const id = parseInt(tile.getAttribute("data_id"));
		const name = tile.getAttribute("data-name") || null; // Obtiene el nombre
		const fileObject = { id: id, name: name, file: null }; // Agrega el nombre al objeto
		filesArray.push(fileObject);
		console.log('Elemento existente añadido al array:', fileObject);
		setupCloseButton(tile, fileObject);
	});

	// Lógica para el botón de carga de archivos
	uploadTile.addEventListener('click', () => {
		const tempFileInput = document.createElement('input');
		tempFileInput.type = 'file';
		tempFileInput.multiple = true;
		tempFileInput.accept = 'application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, application/vnd.ms-powerpoint, application/vnd.openxmlformats-officedocument.presentationml.presentation';
		
		tempFileInput.addEventListener('change', (event) => {
			const files = event.target.files;
			if (files.length > 0) {
				handleFiles(files);
			}
			tempFileInput.remove();
		});

		tempFileInput.click();
	});

	function getIconClass(fileName) {
		const extension = fileName.split('.').pop().toLowerCase();
		switch (extension) {
		case 'pdf':
			return 'ico-pdf';
		case 'xls':
		case 'xlsx':
			return 'ico-xls';
		case 'doc':
		case 'docx':
			return 'ico-doc';
		case 'ppt':
		case 'pptx':
			return 'ico-ppt';
		case 'csv':
			return 'ico-csv';
		case 'jpg':
		case 'jpeg':
		case 'png':
		case 'gif':
		case 'webp':
			return 'ico-img'; // Para archivos de imagen
		default:
			return 'ico-default'; // Ícono por defecto para otros tipos
		}
	}

	// Lógica para manejar los archivos subidos
	function handleFiles(files) {
		const validMimeTypes = [
			'application/pdf',
			'application/msword',
			'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
			'application/vnd.ms-excel',
			'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
			'text/csv',
			'application/vnd.ms-powerpoint',
			'application/vnd.openxmlformats-officedocument.presentationml.presentation'
		];

		for (const file of files) {
			if (validMimeTypes.includes(file.type)) {
				const imageUrl = URL.createObjectURL(file);
				const newTileContainer = document.createElement('div');
				const fileName = file.name;
				const iconClass = getIconClass(fileName);
				newTileContainer.innerHTML = `<div class="tile-photo" role="button" style="background-image: url('${imageUrl}');">
					<div class="${iconClass}"></div>
					<div class="lbl-text">${fileName}</div>
					<div class="item-close">×</div>
				</div>`;
				
				const photoTile = newTileContainer.querySelector('.tile-photo');
				container.appendChild(photoTile);
				
				const fileObject = { id: null, name: file.name, file: file }; // Agrega el nombre del archivo
				filesArray.push(fileObject);
				console.log('Archivo agregado al array:', fileObject);
				setupCloseButton(photoTile, fileObject);
			} else {
				console.warn(`Archivo "${file.name}" no es una imagen válida.`);
			}
		}
	}

	// Lógica para enviar el formulario
	const sendButton = document.querySelector('#send-photos-button');
	if (sendButton) {
		sendButton.addEventListener('click', () => {
			const formData = new FormData();
			formData.append('data_info', JSON.stringify(filesArray));
			var pid = $("#txt_pid").val();
			formData.append('pid', pid);
			document.getElementById("lbl_mensaje").textContent = "Cargando...";

			if (filesArray.length === 0) {
				document.getElementById("lbl_mensaje").textContent = "No hay fotos para enviar.";
				return;
			}

			filesArray.forEach((item) => {
				if (item.file) {
					formData.append('photos[]', item.file);
				} else if (item.id) {
					//formData.append('ids[]', item.id);
					//formData.append('names[]', item.name); 
					// Opcional: Si el backend necesita el nombre del archivo existente, puedes enviarlo
					// formData.append('names[]', item.name);
				}
			});
			
			fetch('/brandkit/files/save', {
				method: 'POST',
				body: formData,
			})
			.then(response => {
				if (!response.ok) {
					throw new Error('La solicitud falló con estado: ' + response.status);
				}
				return response.json();
			})
			.then(data => {
				const fresult = data.message;
				document.getElementById("lbl_mensaje").textContent = "Respuesta: " + fresult;
			})
			.catch(error => {
				console.error('Error al enviar:', error);
				document.getElementById("lbl_mensaje").textContent = "Hubo un error al enviar los archivos.";
			});
		});
	}
</script>
{% endblock %}