<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Información de la marca | C-GENIA</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/brandkit/logo.css') }}">
</head>
<body>
	<header class="topbar">
		<div class="topbar__brand">C-GENIA</div>
	</header>

	<main class="layout">
		<aside class="panel sidebar">
			<div style="padding:0 16px 12px; color:var(--secondary); font-size:12px;">Anunciante</div>
			<div class="sidebar__section">
				<div class="sidebar__section-header">
					<span class="pill" aria-hidden="true"></span>
					<span>Nueva marca</span>
				</div>
				<div class="sidebar__item">Sub-industria</div>
			</div>

			<div class="sidebar__section">
				<div class="sidebar__section-header">Brandkit</div>
				<div class="sidebar__item">Información de la marca</div>
				<div class="sidebar__item">Logos</div>
				<div class="sidebar__item">Imágenes</div>
				<div class="sidebar__item">Colores</div>
				<div class="sidebar__item">Tipografías</div>
				<div class="sidebar__item">Website scan</div>
			</div>

			<div class="sidebar__section">
				<div class="sidebar__section-header">Datos</div>
				<div class="sidebar__item">Fuentes de datos</div>
				<div class="sidebar__item">Templates</div>
			</div>
		</aside>

		<section class="content">
			<main class="logo-content">
				<h1 class="section-title">Logos</h1>

				<div class="info-banner">
					<span class="dot" aria-hidden="true"></span>
					<span>Carga la mayor cantidad de variaciones disponibles del logo. Esto nos permitirá generar contenido de manera más acertada.</span>
				</div>

				<div class="tiles">
					<div class="tile-upload" role="button" aria-label="Agregar logo">
						<div class="tile-upload__inner">
							<div class="plus">+</div>
						</div>
					</div>
					{% for lista in lista %}
					{% set mysrc = lista['asset_src'] %}
					{% set myimage = generar_url_firmada("genia_information",mysrc) %}
					<div class="tile-photo" role="button" aria-label="Agregar logo" style="background-image:url('{{ myimage }}');"></div>
					{% endfor %}
				</div>
				<input type="file" name="photos[]" multiple="" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" wfd-invisible="true">

				<div class="actions">
				  <button class="btn btn-primary" type="button" id="send-photos-button">Subir Photos</button>
				</div>

				<div class="helper">
					<span class="pill" aria-hidden="true"></span>
					<span id="lbl_mensaje"></span>
				</div>
			</main>
		</section>
	</main>
</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', () => {
	const tileUpload = document.querySelector('.tile-upload');
	const tilesContainer = document.querySelector('.tiles');
	let fileInput = null;

	// Función para crear o obtener el input de tipo file oculto
	function getFileInput() {
	    if (!fileInput) {
	        fileInput = document.querySelector('input[name="photos[]"]');
	    }
	    return fileInput;
	}
	// Función para limpiar solo el input file
    function clearFileInput() {
        const input = getFileInput();
        input.value = '';
    }

	tileUpload.addEventListener('click', () => {
		const input = getFileInput();
		input.click(); // Simula el clic en el input oculto

		// Agrega un listener temporal para capturar los archivos seleccionados
		input.addEventListener('change', () => {
            const files = input.files;
            console.log("Archivos agregados:", files); 
            handleFiles(files, false); // `false` indica una selección
        }, { once: true });
	});


	// Función para manejar los archivos
	// Función para manejar los archivos
    function handleFiles(files) {
        if (!files || files.length === 0) {
            console.error('No se seleccionaron archivos.');
            return;
        }

        const validMimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        const currentFiles = getFileInput().files;
        const newFileList = new DataTransfer();

        // Conserva los archivos ya existentes en la nueva lista
        for (let i = 0; i < currentFiles.length; i++) {
            newFileList.items.add(currentFiles[i]);
        }

        // Procesa los nuevos archivos
        for (const file of files) {
            // Verifica si el archivo es válido
            if (validMimeTypes.includes(file.type)) {
                
                // Crea el tile inmediatamente si es una imagen válida
                const imageUrl = URL.createObjectURL(file);
                const newTile = document.createElement('div');
                newTile.className = 'tile-photo';
                newTile.setAttribute('role', 'button');
                newTile.setAttribute('aria-label', `Imagen de: ${file.name}`);
                newTile.style.backgroundImage = `url('${imageUrl}')`;
                //tilesContainer.insertBefore(newTile, tileUpload);
                tilesContainer.appendChild(newTile);

                // Lógica para evitar duplicación del archivo en la lista del input
                const isDuplicate = Array.from(currentFiles).some(existingFile => 
                    existingFile.name === file.name && existingFile.size === file.size
                );

                if (!isDuplicate) {
                    newFileList.items.add(file); // Agrega el archivo solo si no es un duplicado
                } else {
                    console.warn(`Archivo "${file.name}" ya existe y no se añadirá al DataTransfer.`);
                }
            } else {
                console.warn(`Archivo "${file.name}" no es una imagen válida.`);
            }
        }
        
        // Asigna la nueva lista de archivos al input
        getFileInput().files = newFileList.files;
    }

	// Lógica para enviar el formulario
	const sendButton = document.querySelector('#send-photos-button');
	if (sendButton) {
		sendButton.addEventListener('click', () => {
			const formData = new FormData();
			const files = getFileInput().files;
			document.getElementById("lbl_mensaje").textContent = "Cargando...";
			if (files.length === 0) {
				alert('No hay fotos para enviar.');
				return;
			}
			console.log("Archivos que se van a enviar:", files);
			for (const file of files) {
				formData.append('photos[]', file);
				console.log("Agregando al FormData:", file.name);
			}
			
			// Envía la solicitud a la ruta de tu API
			fetch('/brandkit/logos/save', {
				method: 'POST',
				body: formData,
			})
			.then(response => {
				if (!response.ok) {
					throw new Error('La solicitud falló con estado: ' + response.status);
				}
				return response.json();
			})
			.then(data => {
				console.log('Respuesta del servidor:', data);
				const fresult = data.message;
				document.getElementById("lbl_mensaje").textContent = "Respuesta: "+fresult;
				//alert('Fotos enviadas correctamente.');
				clearFileInput();
			})
			.catch(error => {
				console.error('Error al enviar:', error);
				document.getElementById("lbl_mensaje").textContent = "Hubo un error al enviar las fotos.";
			});
		});
	}
});
</script>
